<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - <%= group.name %></title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-200 flex items-center justify-center min-h-screen">

  <div class="w-full max-w-3xl bg-white flex flex-col h-[90vh] rounded-lg shadow">

    <!-- Header bar -->
    <div class="flex items-center justify-between bg-blue-600 text-white px-4 py-3 rounded-t-lg">
      <h2 class="text-xl font-semibold">Group: <%= group.name %></h2>
      <span class="text-sm">Logged in as <%= user.username %></span>
    </div>

    <!-- Messages area -->
    <div id="messages" class="flex-1 overflow-y-scroll bg-gray-100 p-4 space-y-2">
      <% messages.forEach(msg => { %>
        <% if(msg.username === user.username) { %>
          <div class="flex justify-end">
            <div class="bg-blue-500 text-white px-3 py-2 rounded-2xl max-w-xs text-sm shadow">
              <%= msg.message %>
            </div>
          </div>
        <% } else { %>
          <div class="flex justify-start">
            <div class="bg-white px-3 py-2 rounded-2xl border max-w-xs text-sm shadow">
              <span class="block text-blue-600 font-semibold text-xs mb-0.5"><%= msg.username %></span>
              <%= msg.message %>
            </div>
          </div>
        <% } %>
      <% }); %>
    </div>

    <!-- File upload & input -->
    <div class="flex items-center px-3 py-2 bg-gray-50 border-t space-x-2">
      <form action="/chat/<%= group.id %>/upload" method="POST" enctype="multipart/form-data" class="flex items-center">
        <label class="cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500 hover:text-purple-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l4-4m0 0l4 4m-4-4v12" />
          </svg>
          <input type="file" name="file" required class="hidden" onchange="this.form.submit()">
        </label>
      </form>

      <form id="chat-form" class="flex flex-1 items-center space-x-2">
        <input type="text" id="msg" autocomplete="off" placeholder="Type a message"
          class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
        <button class="text-blue-600 hover:text-blue-800 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 rotate-45" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
          </svg>
        </button>
      </form>
    </div>

    <!-- Shared files (scrollable) -->
    <div class="bg-gray-50 px-4 py-3 border-t max-h-40 overflow-y-auto">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">Shared Files</h3>
      <% if (files.length === 0) { %>
        <p class="text-gray-500 text-xs">No files uploaded yet.</p>
      <% } else { %>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <% files.forEach(file => { %>
            <a href="<%= file.filepath %>" download
              class="flex items-center space-x-1 bg-white border rounded-lg px-2 py-1 text-xs hover:bg-gray-100 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 flex-shrink-0" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 4v16m8-8H4" />
              </svg>
              <span class="truncate"><%= file.filename %></span>
            </a>
          <% }); %>
        </div>
      <% } %>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const roomId = "<%= group.id %>";
      const username = "<%= user.username %>";
      const userId = "<%= user.id %>";
      socket.emit('joinRoom', roomId);

      const form = document.getElementById('chat-form');
      const msgInput = document.getElementById('msg');
      const messagesDiv = document.getElementById('messages');

      form.addEventListener('submit', e => {
        e.preventDefault();
        const msg = msgInput.value.trim();
        if (msg) {
          socket.emit('chatMessage', { room: roomId, userId, username, message: msg });
          msgInput.value = '';
        }
      });

      socket.on('chatMessage', data => {
        const div = document.createElement('div');
        if (data.user === username) {
          div.className = 'flex justify-end';
          div.innerHTML = `<div class="bg-blue-500 text-white px-3 py-2 rounded-2xl max-w-xs text-sm shadow">${data.message}</div>`;
        } else {
          div.className = 'flex justify-start';
          div.innerHTML = `<div class="bg-white px-3 py-2 rounded-2xl border max-w-xs text-sm shadow">
            <span class="block text-blue-600 font-semibold text-xs mb-0.5">${data.user}</span>${data.message}</div>`;
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    </script>

  </div>

</body>

</html>
